\chapter{Introducción}
\label{cap1}

A principios del siglo XX se descubrió la existencia de los rayos cósmicos. Estos son partículas subatómicas provenientes del espacio exterior. Estas
partículas, en su mayoría protones y núcleos de Helio  son muy energéticas debido a su gran velocidad. El origen de estas no es muy claro, pero
sabemos que proceden del espacio exterior. Raras veces la actividad del solar puede producir partículas tan energéticas. 
\par
Muchas de estas partículas inciden con la atmósfera terrestre. En las capas altas de la atmósfera se producen las primeras incidencias, estas
partículas colisionan con partículas que forman la atmósfera. Esta colisión es muy violenta y causa la división de las partículas originales en
partículas segundarias. Estas a su vez pueden colisionan con otras partículas de la atmósfera para así formar aún más partículas segundarias. Vemos
como una sola partícula proveniente del espacio produce el fenómeno denominado cascadas atmosféricas. Como es de esperar con cada choque consecutivo
se pierde parte de la energía. Normalmente las partículas segundarias que alcanzan la superficie terrestre tan solo tienen una pequeña fracción de la
energía inicial. Como es de esperar si una partícula no posee la energía suficiente la cascada que origina no se propaga hasta la superficie
terrestre.
\par
Como hemos dicho la mayor parte de la radiación cósmica proviene de fuera de nuestro sistema solar, pero está fuertemente relacionada con los ciclos
solares. Los ciclos solares de 11 años aproximadamente, afectan la actividad solar pasando por un mínimo y un máximo, donde los cambios son
apreciables en la luminosidad y el campo magnético. Es este segundo, el campo magnético solar, el que afecta a la llegada de radiación cósmica a la
Tierra. Al ser mayormente partículas con carga eléctrica, en la presencia de un fuerte campo magnético las partículas son desviadas, por lo que menos
consiguen llegar a la Tierra cuando el campo magnético solar es más fuerte. A continuación detallamos los sucesos más comunes que pueden ser
observados indirectamente a consecuencia de observar la cantidad de radiación cósmica.
\begin{itemize}
	\item	Ciclo solar. Como hemos explicado existe una fuerte relación entre la cantidad de radiación cósmica y la actividad solar. La radiación
		cósmica es un buen indicador de la actividad solar donde la relación es inversa. Menos radiación generalmente significa una actividad
		solar elevada.
	\item	Forbush decrease\cite{Forbush1938}. Estos sucesos consisten en un descenso rápido de los niveles de radiación cósmica medida en la
		Tierra. Estos descensos son consecuencia de CME's. La materia expulsada en un CME al ser en su mayoría plasma extiende e intensifica
		el campo magnético solar. Como ya hemos explicado el aumento del campo magnético solar conlleva al descenso de  radiación cósmica.
	\item	Ground level enhancements. Eventualmente la actividad solar es tan elevada que el Sol es capaz de emitir partículas muy energéticas.
		Estas partículas pueden ser tan energéticas que pueden generar cascadas que alcanzan la superficie terrestre.  Estos sucesos son muy
		raros, entre 10 y 15 por década, aproximadamente. A pesar de ser muy raros estos pueden tener un gran impacto en nuestras vidas
		cotidianas, pueden afectar el funcionamiento de la electrónica sensible que está en orbita e incluso la que está en tierra.   
\end{itemize}

\section{Monitor de neutrones}
	Un monitor de neutrones es una estación terrestre que monitoriza la llegada de partículas extraterrestres de forma indirecta a partir de las
	cascadas atmosféricas. Estos están especialmente diseñados para capturar estas partículas segundarias. Estos se componen por cuatro capas,
	empezaremos explicando primero la capa más exterior y acabaremos explicando la capa más interior.
	\begin{itemize}
		\item	Reflector. La primera capa consiste en un escudo reflector que tan solo deja pasar las partículas con energías altas. De esta
			manera todas las partículas generadas por el entorno inmediato que tienen baja energía rebotan y no influyen en la medición.
		\item	Productor. La siguiente capa, generalmente de material denso tiene como objetivo conseguir algo parecido a las cascadas
			atmosféricas. La idea es tener un material denso para que sea muy probable que las partículas secundarias impacten con las
			partículas del material y como resultado se produzcan más partículas. A las partículas generadas en esta capa se les da el
			nombre de neutrones de evaporación. Son estas partículas las que finalmente serán medidas por el instrumento, también son las
			que le dan nombre. Los neutrones producidos tienen menos energía, por lo que son más fáciles de medir.
		\item	Moderador. A pesar de que las partículas que tenemos a este nivel tienen tan solo una fracción de la energía original estas
			aún siguen siendo demasiado energéticas para ser capturadas. La siguiente capa tiene como objetivo relentizar, disminuir la
			energía, de las partículas para así poder capturarlas.
		\item	Contador. Un contador o tubo contador generalmente está relleno de gas ionizado con propiedades específicas.  Cuando una de
			las partículas relentizadas por el Moderador choca con una de las partículas del gas es liberada una pequeña cantidad de
			energía en forma de electricidad, una señal eléctrica que podemos medir. 
	\end{itemize}
 \par
Los sistemas de adquisición están diseñados para recoger estas pequeñas señales y medirlas. Tradicionalmente la medida que se realiza son eventos por
minuto, las señales son capturadas, amplificadas y registradas en un contador que se reinicia cada minuto. A lo largo de este trabajo muchas veces nos
referiremos a esta medición de eventos por minuto con el nombre de \emph{cuentas}. 

\section{NMDB}
	NMDB\cite{NMDB2011}  o \emph{Neutron Monitor Database} es una red mundial de monitores de neutrones. Antes de proceder a hablar sobre la red
	en concreto expondremos las ventajas y razones de una red como esta.
	\begin{itemize}
		\item 	Espectro de energías. Al igual que el Sol, la Tierra tiene campo magnético. Este campo magnético repele con mayor fuerza en
		  	las regiones ecuatoriales que en los polos. Esto implica que solo las partículas más energéticas son perceptibles en las
			zonas ecuatoriales, mientras que en los polos las partículas no necesitan ser tan energéticas para alcanzar la superficie.
			Combinando dados de estaciones que se encuentran a diferentes latitudes podemos construir espectrogramas basados en la energía
			de las partículas.
		\item 	Anisotropía. Tener estaciones en diferentes lugares del globo terráqueo implica estar orientado a diferente dirección del
		  	espacio. Esto implica el poder hacer estudios sobre la procedencia de eventos.
		\item 	Redundancia. Tener muchas estaciones implica detectar el mismo evento en más de una estación. Esto nos permite comparar
		  	los datos entre estaciones y descartar fluctuaciones grandes, rápidas y asiladas en una sola estación.
		\item 	Cooperación. Estar en una red implica mejorar la comunicación entre las diferentes estaciones. De esta manera los resultados
		  	son mejores y el avance más rápido. 
	\end{itemize}
	\par
	Como ya hemos comentado NMDB es una red mundial, impulsada por la Comisión Europea. Actualmente la red supera las veinte estaciones. La red
	proporciona datos en tiempo real con resolución de 1 minuto. Los formatos de los datos están estandarizados entre las diferentes estaciones,
	esto ayuda al análisis científico de estos. Los datos en tiempo real son utilizados para la elaboración de un sistema de alarma
	GLE\cite{GleAlarm}. Como hemos explicado un GLE fuerte puede tener un impacto grande en nuestras vidas diarias, un impacto negativo. Es
	interesante poder detectar estos eventos lo antes posible, este es uno de los objetivos principales del NMDB. 

\section{CALMA}
	CALMA\cite{Medina2013} es el primer y único monitor de neutrones en España y forma parte del NMDB. Dispone de 15 tubos contadores llenos con
	trifluoruro de boro y un sistema de adquisición de datos que consiste en un sistema empotrado Linux que hace uso de una FPGA que es la
	encargada de llevar las cuentas de los tubos. El sistema de adquisición actual ha sido desarrollado por el equipo de CALMA y también está
	implantado en otras estaciones que forman parte del NMDB. La estación empezó a operar de forma plena de diciembre de 2012 y desde entonces
	lleva haciéndolo ininterrumpidamente con pequeñas excepciones. El equipo técnico a cargo de la estación está profundamente implicado en
	desarrollar sistemas y herramientas que mejoren el funcionamiento del NMDB. La idea para este trabajo es desarrollar el software del nuevo
	sistema de adquisición que el equipo de CALMA está desarrollando, una vez realizado el nuevo sistema de adquisición desarrollaremos una
	herramienta que nos permitirá monitorizar el estado de nuestra estación.
	\par
	Desde su puesta en marcha la estación ha registrado 18 Forbush decreases. Desafortunadamente aún no ha habido ningún GLE que detectar, aunque
	este tendría que ser muy energético para ser detectado en una estación con tan poca latitud.  Procederemos a hablar más a fondo del estado
	actual de CALMA, hablaremos del sistema de adquisición, base de datos, herramientas y técnicas que son usadas.
	\subsection{Sistema de adquisición}
		El sistema de adquisición que está implantado en CALMA es producto del propio equipo\cite{Garcia2014}. El sistema consiste
		un sistema empotrado Linux. Este hace uso de una FPGA que es la encargada de medir los eventos por minuto de los 18 canales. Aunque la
		estación tan solo tenga 15 tubos contadores el sistema esta diseñado para soportar 18, este número es un estándar histórico. Antes de
		llegar a la FPGA las señales pasan por un circuito de adaptación, las señales pasan de analógicas a digitales. El software que se
		ejecuta en el sistema Linux tiene como tarea comunicarse con la FPGA, su labor es recoger las \emph{cuentas} de cada minuto y guardar
		estas en una base de datos.
		\par
		Actualmente el equipo de CALMA está desarrollando un nuevo sistema de adquisición de datos para su estación. Este es muy parecido al
		que actualmente está implantado. Las señales capturadas por los tubos contadores son amplificadas y digitalizadas por un circuito de
		adaptación, seguidamente son procesadas por la FPGA. El software que se ejecuta en el sistema Linux es el encargado de recoger la
		información y guardarla.
		\par
		La primer diferencia entre los dos sistema de adquisición radica en el circuito de adaptación. En el sistema de adquisición actual
		para cada señal el circuito de adaptación genera un pulso fijo. El nuevo sistema de adquisición incorpora nuevo circuito de
		adaptación. Este nuevo circuito de adaptación genera un pulso cuyo ancho de banda es proporcional a la energía de la señal. El fin es
		medir la energía de las partículas detectadas, esta magnitud es de gran interés científico y técnico.
		\par
		La siguiente diferencia está en la FPGA, recordamos que en el sistema de adquisición actual esta tan solo registra los eventos por
		minuto para los 18 canales. La nueva FPGA debe realizar la misma tarea, pero aparte debe poder medir el ancho de los pulsos generados
		por el circuito de adaptación. Los dos sistemas de adquisición utilizan un puerto serie para la comunicación entre software y FPGA, en
		el sistema nuevo este puerto operará a una velocidad mayor a fin de poder transmitir toda la información extra.
		\par
		El nuevo sistema también está pensado para ofrecer una mayor compatibilidad. El fin es poder implantar este en diferentes estaciones
		de forma fácil y rápida. El hardware  y software deben ser diseñados con este requisito en mente.
	\subsection{Bases de datos}
		La base de datos que genera CALMA está diseñada de acuerdo con el estándar impuesto por NMDB. Existen dos réplicas de la
		base de datos. Tenemos una réplica de los datos crudos adquiridos en el propio sistema, para gestionar esta réplica es utilizado
		Sqlite3. La segunda réplica está en otra máquina conectada por red con el sistema de adquisición de datos. Esta contiene los datos
		crudos y también contiene la corrección por presión de estos. Para la segunda réplica es utilizado MySQL. Los datos que son mandados
		al NMDB son los datos de la segunda réplica.
	\subsection{Herramientas y técnicas}
		El equipo de CALMA hace uso de herramientas que les ayudan a analizar la información desde el punto de vista científico.
		Estas herramientas están muy bien para los científicos, pero actualmente no existe ninguna herramienta que dé información sobre el
		estado técnico de la estación. Todas las labores relacionadas con el mantenimiento son realizadas de forma manual.

\section{Objetivos}
	El objetivo de este proyecto es desarrollar el software para el nuevo sistema de adquisición de datos y también desarrollar una herramienta
	que permite operar y monitorizar el estado de la estación. A continuación procederemos a hacer una descripción más detallada de los objetivos
	de este trabajo.  
	\subsection{Software de adquisición de datos}
		Tal y como hemos explicado en secciones anteriores el equipo de CALMA esta desarrollando un nuevo sistema de adquisición. Actualmente
		la mayoría de módulos hardware incluyendo la FPGA están listos. El propósito de este trabajo es realizar el software de adquisición. A
		continuación exponemos algunos de los requisitos más relevantes.
		\begin{itemize}
			\item 	El software debe ser capaz de realizar una correcta comunicación con la FPGA. Esto implica enviar los comandos
				apropiados y ser capaz de interpretar los mensajes de datos trasmitidos por la esta. En el capítulo \ref{entornoHW}
				podemos obtener más información sobre la interfaz de comunicación con la FPGA.
			\item 	El software debe ser capaz de mantener dos bases de datos, una replica local y una remota.
			\item 	Al igual que el hardware el software debe ser capaz de adaptarse fácilmente a diferentes estaciones. Para este
				propósito este debe ser diseñado de tal forma que sea fácil de extender.
			\item 	El software debe ser capaz de poner en marcha la estación completa en funcionamiento de forma automática ante la
			  	presencia de corriente eléctrica. 
			\item 	El software debe ser capaz de detectar estados anormales y actuar conforme a estos. En una estación de este tipo
				funcionar mal la mayoría de veces es no generar datos o generar datos anormales. Ante la presencia de un estado
				anormal debe generarse una alarma. En muchos casos realizar un reinicio del sistema es útil. 
		\end{itemize}
		Aparte de la realización del software en este trabajo también contemplamos el proceso de implantación y mantenimiento de este.
		Volvemos a recordar que los demás modulo que componen el sistema de adquisición son desarrollados por el equipo de CALMA. A lo largo
		de este trabajo se describirán las interfaces de estos dado que es necesario para entender este trabajo. 
	\subsection{Herramienta Web}
		El segundo objetivo de este trabajo es el desarrollo de una herramienta que facilite la gestión de una estación. La idea de esta
		herramienta es del equipo de CALMA. Procederemos a detallar las funcionalidades de la herramienta tal y como las concibe el equipo de
		CALMA.
		%TODO Citar el artículo de la herramienta.
		\begin{itemize}
	         	\item	Spike Tool. Módulo que permitirá la detección de Spikes. Usando los datos proporcionados por el sistema de
			  	adquisición este módulo debe generar gráficos. Estos gráficos serán interactivos y su propósito será hacer fácil la
				detección de Spikes. Los Spikes detectados podrán ser marcados como nulos en el conjunto de datos revisados. 
			\item 	Configuración de la estación. Este módulo permitirá cambiar la configuración de la estación. Esta reconfiguración será
				llevada a cabo en tiempo real sin interrumpir el proceso de adquisición. Nótese que el software de adquisición debería
				evolucionar para hacer posible esta funcionalidad.
			\item	Alertas. La herramienta visualizará las alertas producidas por el software de adquisición.
			\item 	Histogramas con la intensidad de los eventos. El nuevo sistema de adquisición proporciona información sobre la energía
				de las partículas incidentes. Este módulo debería generar histogramas con estos datos. Estos histogramas permitirán
				hacer mejores diagnósticos sobre el funcionamiento de los tubos contadores. 
		\end{itemize}
		Podemos ver que la herramienta ofrece un gran abanico de funcionalidades, por desgracia en este trabajo tan solo nos centraremos en el
		primer módulo. Realizar los demás módulos estaría fuera del alcance de un trabajo como este. También es de destacar que tan solo nos
		centraremos en la implementación, no implantaremos ni mantendremos la herramienta. La herramienta será una herramienta Web intuitiva y
		altamente interactiva. 

\section{Diseño preliminar}
	Procedernos a especificar un diseño preliminar para el software de adquisición y para la herramienta web.
	\subsection{Software de adquisición}
		El sistema de adquisición que se está desarrollando es un sistema empotrado donde hardware y software están muy vinculados. En el
		capítulo \ref{entornoHW} se describe más a fondo el entrono hardware, en este punto tan solo mencionaremos que el software se
		ejecutará sobre una BeagleBone Black\cite{Beagle} que está integrada con el resto de componentes hardware. Destacamos que el autor de
		este trabajo no ha formado parte en el desarrollo hardware. En la BeagleBone tendremos un sistema empotrado Linux, la distribución
		elegida para desarrollar este trabajo es Ångström. Actualmente nos estamos planteando cambiar la distribución a alguna derivada de
		Debian, sobre esto hablaremos más a fondo en el capítulo \ref{cap_conclusiones}. El desarrollo del software se hará en
		Python\cite{Python}, lenguaje interpretado de alto nivel. Actualmente Python es muy popular y existen muchas librerías de las que
		haremos uso. Usar librerías reduce la carga de trabajo y normalmente resulta en software más robusto. Para la gestión de la base de
		datos hemos elegido Sqlite3\cite{Sqlite}, una elección popular en sistemas empotrados como el que estamos realizando. 
		\par
		En la figura \ref{fig:soft_control_preliminar} podemos ver el diseño preliminar de nuestro software. Ante la presencia de corriente
		eléctrica el sistema de adquisición se inicia solo. Nuestro software debe configurar la estación de acuerdo con el archivo de
		configuración proporcionado. Una vez configurada la estación pasamos al funcionamiento nominal. El software debe recoger la
		información que generan los diferentes módulos que componen el sistema. Cada minuto la información es guardada en una base de datos.
		\begin{figure}[h]
			\centering
			\includegraphics[keepaspectratio, width=1\textwidth]{./img/soft_control_preliminar.png}
			\caption{Software de adquisición. Diseño preliminar.}
			\label{fig:soft_control_preliminar}
		\end{figure}
	\subsection{Herramienta Web}
		En la figura \ref{fig:herramienta_web_preliminar} podemos ver el diseño de nuestra herramienta. Como podemos ver el diseño está
		fuertemente basado en el patrón MVC\cite{MVCWiki}. A continuación explicaremos los tres componentes básicos. 
		\begin{description}
			\item[Base de Datos]    
				En este componente residen los datos de nuestra estación. Para la gestión de estos utilizamos un servidor
				MySQL\cite{MySql}.
			\item[\emph{Back-End}]
				Este componente es el encargado de recibir y procesar las solicitudes provenientes del \emph{Front-End}. Una vez
				procesadas las solicitudes si estas son válidas este componente se comunica con la base de datos para ejecutar las
				solicitudes. Por último devuelve los resultados de las solicitudes. Para la implementación de este componente hemos
				utilizado ZendFramework\cite{ZF} y Apygility\cite{Apigility}.  
			\item[\emph{Front-end}] 
				Este componente implementa la interfaz de nuestra aplicación. Es el encargado de presentarnos la información y manejar
				las peticiones del usuario. El módulo está basado en el patrón MVC. Para implementar la Vista hemos utilizado
				HighStock\cite{HighStock}, para el Controlador ExtJs\cite{ExtJs} y para el modelo peticiones Ajax\cite{AjaxWiki}.
		\end{description}
		\begin{figure}[h]
			\centering
			\includegraphics[keepaspectratio, width=1\textwidth]{./img/herramienta_web_preliminar.png}
			\caption{Herramienta Web. Diseño preliminar}
			\label{fig:herramienta_web_preliminar}
		\end{figure}
\section{Proceso de adquisición}
	En este punto explicaremos más a fondo el funcionamiento de un monitor de neutrones, dado que es necesario para poder entender este trabajo.
	\subsection{Adaptación y procesado de las señales}
		Como ya comentamos, la radiación cósmica termina generando neutrones de baja energía. Son estas partículas las que interaccionan con
		el gas de los tubos contadores, en el proceso es liberada una pequeña cantidad de energía. Esta pequeña cantidad de energía es
		capturada en forma de señal eléctrica. Las señales resultantes son muy pequeñas, por lo que estas pasan por un circuito de adaptación. 
		\par
		En el circuito de adaptación las señales son amplificadas y digitalizadas. En el sistema de adquisición actual para cada señal el
		circuito de adaptación genera un pulso fijo. El nuevo sistema de adquisición incorpora nuevo circuito de adaptación. Este nuevo
		circuito de adaptación genera un pulso cuyo ancho de banda es proporcional a la energía de la señal. 
		\par
		Las señales generadas por el circuito de adaptación son dirigidas a la FPGA. La FPGA procesa las señales entrantes, para cada pulso
		recibido registra un evento y además mide el ancho del pulso. La información es entonces transmitida a la BeagleBone Black, a nuestro
		software de adquisición. Más adelante en este trabajo explicaremos la interfaz de comunicación entre la BeagleBone y la FPGA, en este
		punto la vamos a omitir. 
		\par
		Como hemos podido ver la información de los eventos termina en manos de nuestro software de adquisición. El software se encarga de
		recibir correctamente dicha información y de guardarla en una base de datos con resolución de 1 minuto.
	\subsection{Múltiples Tubos}
		Hasta ahora siempre hemos hablado de tubos contadores, en plural, detrás de esto hay una razón. Normalmente las estaciones se componen
		de varios tubos contadores, donde 18 tubos contadores es un estándar. Vamos a explicar el motivo de tener muchos tubos contadores. 
		\par
		En el proceso de adquisición están envueltos muchos factores probabilísticos, esto conlleva a que las medidas en un tubo tengan una
		gran dispersión. Tener tan solo un tubo no sería práctico, los datos tendrían gran dispersión. La solución de este problema es tener
		mucho tubos, cuantos más mejor.
	\subsection{Valor global y correcciones}
		Tener los datos de muchos tubos es bueno, sin embargo no es muy práctico trabajar con esos datos en crudo. Tener un valor global de
		toda la estación es más representativo. Es por eso por lo que el sistema de adquisición calcula uno a partir de los datos de todos los
		tubos. Hay diferentes modos de calcular este valor global y es algo que está en continua discusión. Nosotros también vamos a calcular
		este valor, utilizaremos el Median Algorithm\cite{MedianAlgr}.
		\par
		Anteriormente hemos comentado que también medimos el valor de la presión atmosférica. Medimos este valor porque es útil. Ya hemos
		explicado las cascadas atmosféricas donde partículas de la atmósfera chocan unas con otras. Tener diferentes niveles de presión
		atmosféricas afecta a las cascadas atmosféricas, en consecuente a la cantidad de partículas que llegan a la superficie terrestre, a
		menos presión, más partículas, y a más presión, menos partículas. Resumiendo este último párrafo  podemos decir que el valor global
		sin corregir es un indicativo de cuanta radiación cósmica llega a la superficie terrestre, y el valor corregido en función de la
		presión es un indicativo de cuanta radiación cósmica llega a nuestra atmósfera.
	\subsection{Fuentes de alimentación de alta tensión}
		Para funcionar los tubos contadores requieren una corriente de alta tensión y baja intensidad. La corriente es utilizada por los tubos
		para ionización del gas dentro del tubo. La ionización del gas afecta al funcionamiento de los tubos, por lo que cambios en la
		corriente subministrada pueden afectar al sistema de adquisición. Es por esta razón por la que el funcionamiento de las HVPS es
		supervisado. Es de esperar que la corriente sea constante, por lo que no es necesaria ninguna corrección en función de esta. En caso
		de variaciones en la corriente los datos generados son considerados no consistentes.
	\subsection{\emph{Spike}}
		Un \emph{spike} es un dato anómalo, un dato anormalmente grande o pequeño. Son datos producidos por malfuncionamientos de la
		instrumentación, cambios bruscos en el entorno inmediato u otros factores desconocidos. Los \emph{spikes} están presentes en todas las
		estaciones. Con la elaboración del nuevo sistema de adquisición se pretende reducir el número \emph{spikes} generados. La herramienta
		Web nos permitirá localizar y descartar los \emph{spikes} de forma fácil.  
